<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style_home.css">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">

    <title>Question Booth - Marble Run x LINK centre</title>
    <style>
        .modern-title {
            font-size: 2rem;
            letter-spacing: -1px;
            font-weight: 250;
            border-left: 5px solid #FF5E62;
            padding-left: 15px;
            margin-bottom: 15px;
        }

        /* Custom navbar styling */
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 80px;
        }

        .navbar-light .navbar-nav .nav-link {
            color: black;
        }

        .navbar-light .navbar-nav .nav-link:hover {
            color: #724D00;
        }

        .navbar-light .navbar-nav .nav-link.active {
            font-weight: bold;
            color: #FF5E62;
        }

        .button-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            position: relative;
            top: 300px;
        }

        .btn {
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            margin: 0 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        h4.mb-3 {
            font-weight: 600;
            color: var(--text-color);
            margin: 2rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--hover-color);
            transform: translateY(-1px);
        }

        @media (max-width: 576px) {
            .container {
                padding: 1rem;
            }

            .responsive-text {
                font-size: 14px;
            }

            .button-container {
                display: none;
            }

            .text-item h3 {
                font-size: 16px;
            }

            .headline-container img {
                width: 100%;
                padding: 10%;
            }
        }

        @media (min-width: 577px) and (max-width: 768px) {
            .responsive-text {
                font-size: 16px;
            }

            .button-container {
                display: none;
            }

            .text-item h3 {
                font-size: 18px;
            }
        }

        @media (min-width: 769px) and (max-width: 992px) {
            .responsive-text {
                font-size: 18px;
            }

            .button-container {
                display: none;
            }

            .text-item h3 {
                font-size: 20px;
            }
        }

        @media (min-width: 993px) and (max-width: 1200px) {
            .responsive-text {
                font-size: 20px;
            }

            .button-container {
                display: none;
            }
        }

        @media (min-width: 1201px) and (max-width: 1400px) {
            .responsive-text {
                font-size: 22px;
            }

            .button-container {
                display: none;
            }
        }

        @media (min-width: 1401px) and (max-width: 1600px) {
            .responsive-text {
                font-size: 24px;
            }
        }

        @media (min-width: 1601px) and (max-width: 18000px) {
            .responsive-text {
                font-size: 26px;
            }
        }

        .scrollable-textarea {
            height: 200px;
            overflow-y: auto;
        }

        #sectionTitle {
            transition: opacity 0.3s ease;
            margin-left: 1rem;
            font-weight: 500;
        }

        .section-box {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .section-box:hover {
            box-shadow: 0 6px 28px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .section-box img.round {
            border-radius: 12px;
            transition: transform 0.3s ease;
        }

        .section-box {
            background-color: transparent;
            padding: 1.5rem;
            border-radius: 12px;
        }

        @media (max-width: 768px) {
            .section-box {
                padding: 1rem;
            }
        }

        li.active {
            font-weight: bold;
        }

        .btn.rounded-pill:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: inherit !important;
        }

        .btn.btn-warning.rounded-pill {
            color: white !important;
        }

        .btn.btn-warning.rounded-pill:hover {
            color: white !important;
        }

        .btn.btn-info.rounded-pill {
            color: white !important;
        }

        .btn.btn-info.rounded-pill:hover {
            color: white !important;
        }

        .btn.btn-primary.rounded-pill {
            color: white !important;
        }

        .btn.btn-primary.rounded-pill:hover {
            color: white !important;
        }

        .card.mb-3 {
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid var(--border-color);
            overflow: hidden;
            border-radius: 10px;
        }

        .card.mb-3:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .card-header {
            background-color: var(--secondary-color) !important;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.25rem;
        }

        .prompt-card .card-header {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .action-buttons {
            opacity: 1;
        }

        .card-body:hover .action-buttons {
            opacity: 1;
        }

        .action-buttons .btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            border: none;
        }

        .action-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .action-buttons .btn i {
            font-size: 0.8rem;
        }

        .copy-btn {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6 !important;
        }

        .copy-btn:hover {
            background-color: #6c757d;
            color: white;
        }

        .edit-btn {
            background-color: #f8f9fa;
            color: #0d6efd;
            border: 1px solid #dee2e6 !important;
        }

        .edit-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .delete-btn {
            background-color: #f8f9fa;
            color: #dc3545;
            border: 1px solid #dee2e6 !important;
        }

        .delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-primary {
            background-color: #0d6efd;
        }

        .btn-primary:hover {
            background-color: #0b5ed7;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #bb2d3b;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-text {
            font-size: 1.05rem;
            line-height: 1.5;
            color: #445566;
        }

        /* Quiz System Styles */
        .quiz-section {
            margin-top: 3rem;
            padding: 2rem 0;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .topic-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: white;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .topic-card.completed {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .topic-card.completed:hover {
            transform: none;
            box-shadow: none;
        }

        .completed-badge {
            background: #28a745;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .topic-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .difficulty-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .difficulty-easy {
            background: rgba(46, 204, 113, 0.8) !important;
        }

        .difficulty-medium {
            background: rgba(241, 196, 15, 0.8) !important;
        }

        .difficulty-hard {
            background: rgba(231, 76, 60, 0.8) !important;
        }

        .topic-description {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .topic-card:hover .topic-description {
            transform: translateY(0);
        }

        /* Quiz Modal Styles */
        .quiz-modal .modal-dialog {
            max-width: 800px;
        }

        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px 10px 0 0;
        }

        .quiz-timer {
            background: #ff6b6b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .quiz-timer.warning {
            background: #ffa726;
            animation: pulse 1s infinite;
        }

        .quiz-timer.danger {
            background: #ef5350;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .question-container {
            padding: 2rem;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }

        .question-number {
            background: #3498db;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-right: 1rem;
        }

        .answer-options {
            margin-bottom: 2rem;
        }

        .answer-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .answer-option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }

        .answer-option.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .answer-option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .number-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
        }

        .number-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .quiz-results {
            text-align: center;
            padding: 2rem;
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .score-message {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 2rem;
        }

        .admin-section {
            margin-top: 3rem;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .admin-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-table th {
            background: #667eea;
            color: white;
            padding: 1rem;
            font-weight: 600;
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .admin-table tr:hover {
            background: #f8f9fa;
        }

        /* Q&A Questions Styling */
        .questions-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .question-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .question-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .question-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .question-topic {
            background: #667eea;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .question-status {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #ffa726;
            color: white;
        }

        .status-answered {
            background: #66bb6a;
            color: white;
        }

        .status-rejected {
            background: #ef5350;
            color: white;
        }

        .question-meta {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .question-text {
            color: #2c3e50;
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .question-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Modal fixes for proper display */
        .modal {
            z-index: 1050;
        }

        .modal-backdrop {
            z-index: 1040;
        }

        .modal-content {
            background-color: white;
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Quiz modal specific styling */
        .quiz-modal .modal-dialog {
            max-width: 800px;
        }

        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px 10px 0 0;
        }

        /* Team Progress Styling */
        .progress {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
        }

        .badge.bg-success {
            background-color: #28a745 !important;
        }

        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }

        .team-progress-row:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <!-- Shared Navbar Container -->
    <div id="navbar-container"></div>


    <!-- Quiz Section (Hidden for admin users) -->
    <div class="container quiz-section" id="quizSection">
        <div class=" row">
            <div class="col-12">
                <h2 class="text-center mt-4 mb-4">Question Booth</h2>
                <p class="text-center text-muted mb-4">Take quizzes to test your STEM knowledge across 10 different
                    topics.</p>

                <!-- Main Action Buttons -->
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <button class="btn btn-success btn-lg" onclick="showQuizTopics()">
                        <i class="fas fa-brain me-2"></i>Take a Quiz
                    </button>
                    <button class="btn btn-warning btn-lg" id="adminAccessBtn" data-bs-toggle="modal"
                        data-bs-target="#adminAccessModal">
                        <i class="fas fa-cog me-2"></i>Admin Access
                    </button>
                </div>

                <!-- User Token Display (Hidden for admin users) -->
                <div class="row justify-content-center mb-4" id="userProgressSection">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Your Progress</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="token-display">
                                            <h3 class="text-warning mb-1" id="userTotalTokens">0</h3>
                                            <p class="text-muted mb-0">Total Tokens Earned</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="progress-display">
                                            <h3 class="text-info mb-1" id="userCompletedTopics">0/10</h3>
                                            <p class="text-muted mb-0">Topics Completed</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Admin Badge (shown only for admin user) -->
                                <div id="adminBadge" class="mt-2" style="display: none;">
                                    <span class="badge bg-danger fs-6">
                                        <i class="fas fa-shield-alt me-1"></i>ADMIN USER
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshUserProgress()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh Progress
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Topic Grid (shown when quiz button is clicked) -->
                <div class="topic-grid d-none" id="topicGrid">
                    <!-- Topics will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Section (Hidden by default) -->
    <div class="container admin-section" id="adminSection" style="display: none;">
        <div class="row">
            <div class="col-12">
                <!-- Team Progress Dashboard -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">Team Progress Dashboard</h3>
                    <div>
                        <button class="btn btn-primary me-2" onclick="loadTeamProgress()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Progress
                        </button>
                        <button class="btn btn-warning me-2" onclick="randomizeAllPasscodes()">
                            <i class="fas fa-random me-2"></i>Randomize Passcodes
                        </button>
                        <button class="btn btn-info me-2" onclick="exportUserCredentials()">
                            <i class="fas fa-download me-2"></i>Export CSV
                        </button>
                        <button class="btn btn-danger" onclick="resetAllData()">
                            <i class="fas fa-trash me-2"></i>Reset All Data
                        </button>
                    </div>
                </div>
                <div class="admin-table mb-5">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Team Name</th>
                                <th>Completed Topics</th>
                                <th>Total Score</th>
                                <th>Total Tokens</th>
                                <th>Average Score</th>
                                <th>Last Quiz</th>
                            </tr>
                        </thead>
                        <tbody id="teamProgressTable">
                            <!-- Team progress will be loaded here -->
                        </tbody>
                    </table>
                </div>


                <!-- Quiz Questions Overview -->
                <h3 class="mb-4">Quiz Questions Overview</h3>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Total Questions: <span id="totalQuestionsCount">0</span></span>
                    <div>
                        <button class="btn btn-success me-2" onclick="showEditQuizModal()">
                            <i class="fas fa-edit me-2"></i>Edit Quiz Questions
                        </button>
                        <button class="btn btn-primary" onclick="loadQuizQuestions()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Questions
                        </button>
                    </div>
                </div>
                <div class="questions-container" id="questionsContainer">
                    <!-- Quiz questions will be loaded here -->
                </div>

                <!-- User Management Section -->
                <h3 class="mb-4">User Management</h3>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Total Users: <span id="totalUsersCount">0</span></span>
                    <div>
                        <button class="btn btn-info me-2" onclick="loadUserManagement()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Users
                        </button>
                        <button class="btn btn-success" onclick="showPasscodeModal()">
                            <i class="fas fa-plus me-2"></i>Add New Passcode
                        </button>
                    </div>
                </div>
                <div class="admin-table mb-5">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Passcode</th>
                                <th>Last Login</th>
                                <th>User Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTable">
                            <!-- User data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JavaScript Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FontAwesome Icons -->
    <script src="https://kit.fontawesome.com/e067495424.js" crossorigin="anonymous"></script>

    <!-- Modal Structure -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">工作坊花絮</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex justify-content-center align-items-center">
                    <img id="modalImage" class="img-fluid" src="" alt="" style="max-height: 90vh; max-width: 90vw;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" id="prevBtn" onclick="changeImage(-1)">上一張</button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeImage(1)">下一張</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">登入</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3 mx-4">
                            <label for="passcode" class="mt-4 form-label">密碼 (4位)</label>
                            <input type="text" class="form-control" id="passcode" maxlength="4" required>
                        </div>
                        <button type="submit" class="btn btn-primary mx-4 mb-4">確認</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Access Modal -->
    <div class="modal fade" id="adminAccessModal" tabindex="-1" aria-labelledby="adminAccessModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminAccessModalLabel">
                        <i class="fas fa-shield-alt me-2"></i>Admin Access
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adminAccessForm">
                        <div class="mb-3">
                            <label for="adminPasscode" class="form-label">Admin Passcode</label>
                            <input type="password" class="form-control" id="adminPasscode"
                                placeholder="Enter admin passcode" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-unlock me-2"></i>Access Admin Panel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal fade quiz-modal" id="quizModal" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="quiz-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="modal-title" id="quizModalLabel">Quiz: <span id="quizTopicName"></span></h5>
                        <div class="quiz-timer" id="quizTimer">4:00</div>
                    </div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill" id="quizProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="question-container" id="questionContainer">
                    <!-- Questions will be loaded here -->
                </div>

                <div class="quiz-navigation">
                    <button type="button" class="btn btn-secondary" id="prevQuestionBtn" disabled>Previous</button>
                    <span id="questionCounter">Question 1 of 10</span>
                    <button type="button" class="btn btn-primary" id="nextQuestionBtn">Next</button>
                    <button type="button" class="btn btn-success" id="submitQuizBtn" style="display: none;">Submit
                        Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Results Modal -->
    <div class="modal fade" id="quizResultsModal" tabindex="-1" aria-labelledby="quizResultsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quizResultsModalLabel">Quiz Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="quiz-results">
                    <div class="score-display" id="finalScore">0/10</div>
                    <div class="score-message" id="scoreMessage">Great job!</div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Note: Q&A modals removed - only quiz functionality remains -->

    <!-- Edit Quiz Modal -->
    <div class="modal fade" id="editQuizModal" tabindex="-1" aria-labelledby="editQuizModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuizModalLabel">
                        <i class="fas fa-edit me-2"></i>Edit Quiz Questions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Quiz Topics</h6>
                            <div class="list-group" id="quizTopicsList">
                                <!-- Topics will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="quizEditor">
                                <p class="text-muted">Select a topic to edit its questions.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveQuizChanges()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Passkey Modal -->
    <div class="modal fade" id="editPasskeyModal" tabindex="-1" aria-labelledby="editPasskeyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPasskeyModalLabel">
                        <i class="fas fa-key me-2"></i>Edit User Passkey
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPasskeyForm">
                        <div class="mb-3">
                            <label for="editUserId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="editUserId" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editPasscode" class="form-label">Current Passcode</label>
                            <input type="text" class="form-control" id="editCurrentPasscode" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editNewPasscode" class="form-label">New Passcode</label>
                            <input type="text" class="form-control" id="editNewPasscode" maxlength="4"
                                placeholder="Enter 4-character passcode" required>
                            <div class="form-text">Passcode must be exactly 4 alphanumeric characters (A-Z, 0-9)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateUserPasskey()">
                        <i class="fas fa-save me-2"></i>Update Passkey
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Passcode Modal -->
    <div class="modal fade" id="addPasscodeModal" tabindex="-1" aria-labelledby="addPasscodeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPasscodeModalLabel">
                        <i class="fas fa-plus me-2"></i>Add New Passcode
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPasscodeForm">
                        <div class="mb-3">
                            <label for="newUserId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="newUserId"
                                placeholder="Enter user ID (e.g., 202)" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPasscode" class="form-label">Passcode</label>
                            <input type="text" class="form-control" id="newPasscode" maxlength="4"
                                placeholder="Enter 4-character passcode" required>
                            <div class="form-text">Passcode must be exactly 4 alphanumeric characters (A-Z, 0-9)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addNewPasscode()">
                        <i class="fas fa-plus me-2"></i>Add Passcode
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="quiz-system.js"></script>
    <script>
        // Set active navbar item for this page
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                const questionBoothLink = document.querySelector('a[href="question-booth.html"]');
                if (questionBoothLink) {
                    questionBoothLink.classList.add('active');
                }

                // Load user progress
                setTimeout(() => {
                    loadUserProgress();
                }, 1000);
            }, 100);
        });

        // Show quiz topics function
        function showQuizTopics() {
            const topicGrid = document.getElementById('topicGrid');
            if (topicGrid) {
                topicGrid.classList.remove('d-none');
                // Initialize quiz system if not already done
                if (typeof QuizSystem !== 'undefined') {
                    new QuizSystem();
                }
            }
        }

        // Note: Q&A form handler removed - now using quiz questions in admin panel

        // Function to load quiz questions (for admin)
        async function loadQuizQuestions() {
            try {
                console.log('Loading quiz questions...');
                const response = await fetch('/api/quiz-topics');
                const data = await response.json();

                console.log('Quiz topics response:', data);

                if (data.topics) {
                    renderQuizQuestions(data.topics);
                } else {
                    console.error('No quiz topics data received');
                }
            } catch (error) {
                console.error('Failed to load quiz questions:', error);
            }
        }

        // Function to render quiz questions
        function renderQuizQuestions(topics) {
            console.log('Rendering quiz questions with topics:', topics);
            const container = document.getElementById('questionsContainer');
            const countElement = document.getElementById('totalQuestionsCount');

            if (!container || !countElement) {
                console.error('Container or count element not found');
                return;
            }

            // Calculate total questions across all topics
            const totalQuestions = topics.reduce((total, topic) => total + topic.questions.length, 0);
            console.log('Total questions calculated:', totalQuestions);
            countElement.textContent = totalQuestions;

            if (topics.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No quiz topics found.</p>';
                return;
            }

            let html = '';
            topics.forEach(topic => {
                html += `
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-brain me-2"></i>${topic.name}
                                <span class="badge bg-secondary ms-2">${topic.difficulty.toUpperCase()}</span>
                            </h5>
                            <small class="text-muted">${topic.description}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;

                topic.questions.forEach((question, index) => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Question ${index + 1}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><strong>${question.question}</strong></p>
                                    ${question.type === 'multiple-choice' ? `
                                        <div class="options">
                                            ${question.options.map((option, optIndex) => `
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" disabled>
                                                    <label class="form-check-label ${optIndex === question.correct ? 'text-success fw-bold' : ''}">
                                                        ${String.fromCharCode(65 + optIndex)}. ${option}
                                                        ${optIndex === question.correct ? ' ✓' : ''}
                                                    </label>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="alert alert-info">
                                            <strong>Answer:</strong> ${question.answer}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Note: Old Q&A question functions removed - now using quiz questions

        // Function to load team progress
        async function loadTeamProgress() {
            try {
                const response = await fetch('/api/team-progress', { credentials: 'include' });
                const data = await response.json();

                if (data.teamProgress) {
                    renderTeamProgress(data.teamProgress);
                } else {
                    console.error('No team progress data received');
                }
            } catch (error) {
                console.error('Failed to load team progress:', error);
            }
        }

        // Function to load and display user progress
        async function loadUserProgress() {
            try {
                console.log('loadUserProgress() called');

                // Get current user ID first
                const authResponse = await fetch('/api/auth-status', { credentials: 'include' });
                const authData = await authResponse.json();

                console.log('Auth response:', authData);

                if (!authData.authenticated) {
                    console.log('User not authenticated, showing 0 progress');
                    document.getElementById('userTotalTokens').textContent = '0';
                    document.getElementById('userCompletedTopics').textContent = '0/10';
                    document.getElementById('adminBadge').style.display = 'none';
                    return;
                }

                // Show admin badge if user is admin
                if (authData.isAdmin) {
                    document.getElementById('adminBadge').style.display = 'block';

                    // Hide quiz section and user progress for admin users
                    const quizSection = document.getElementById('quizSection');
                    const userProgressSection = document.getElementById('userProgressSection');
                    if (quizSection) quizSection.style.display = 'none';
                    if (userProgressSection) userProgressSection.style.display = 'none';

                    // Update admin access button for admin user
                    const adminBtn = document.getElementById('adminAccessBtn');
                    if (adminBtn) {
                        adminBtn.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Admin Panel';
                        adminBtn.className = 'btn btn-danger btn-lg';
                        adminBtn.onclick = function () {
                            // Toggle admin panel visibility
                            const adminSection = document.getElementById('adminSection');
                            if (adminSection.style.display === 'none') {
                                adminSection.style.display = 'block';
                                loadQuizQuestions();
                                loadTeamProgress();
                                loadUserManagement();
                            } else {
                                adminSection.style.display = 'none';
                            }
                        };
                    }

                    // Automatically show admin panel for admin user
                    const adminSection = document.getElementById('adminSection');
                    if (adminSection && adminSection.style.display === 'none') {
                        adminSection.style.display = 'block';
                        // Load admin data
                        loadQuizQuestions();
                        loadTeamProgress();
                        loadUserManagement();
                    }
                } else {
                    document.getElementById('adminBadge').style.display = 'none';

                    // Show quiz section and user progress for non-admin users
                    const quizSection = document.getElementById('quizSection');
                    const userProgressSection = document.getElementById('userProgressSection');
                    if (quizSection) quizSection.style.display = 'block';
                    if (userProgressSection) userProgressSection.style.display = 'flex';

                    // Reset admin access button for non-admin users
                    const adminBtn = document.getElementById('adminAccessBtn');
                    if (adminBtn) {
                        adminBtn.innerHTML = '<i class="fas fa-cog me-2"></i>Admin Access';
                        adminBtn.className = 'btn btn-warning btn-lg';
                        adminBtn.setAttribute('data-bs-toggle', 'modal');
                        adminBtn.setAttribute('data-bs-target', '#adminAccessModal');
                        adminBtn.onclick = null;
                    }
                }

                const currentUserId = authData.userId;
                console.log('Loading progress for user:', currentUserId);

                // Get user's quiz results
                const response = await fetch('/api/user-quiz-results', { credentials: 'include' });
                const data = await response.json();

                console.log('Quiz results response:', data);

                if (data.results && Array.isArray(data.results)) {
                    const userResults = data.results;
                    let totalTokens = 0;
                    let completedTopics = 0;

                    console.log('Processing results for user:', currentUserId);
                    console.log('All results:', userResults);

                    // Filter results by current user and calculate totals
                    userResults.forEach(result => {
                        console.log('Checking result:', result);
                        if (result.userId === currentUserId) {
                            console.log('Found matching result for user', currentUserId, ':', result);
                            if (result.tokensEarned) {
                                totalTokens += result.tokensEarned;
                                console.log('Added tokens:', result.tokensEarned, 'Total now:', totalTokens);
                            }
                            completedTopics++;
                            console.log('Completed topics now:', completedTopics);
                        }
                    });

                    // Update the display
                    document.getElementById('userTotalTokens').textContent = totalTokens;
                    document.getElementById('userCompletedTopics').textContent = `${completedTopics}/10`;

                    console.log('Final user progress for user', currentUserId, ':', { totalTokens, completedTopics });
                } else {
                    // No results yet
                    document.getElementById('userTotalTokens').textContent = '0';
                    document.getElementById('userCompletedTopics').textContent = '0/10';
                    console.log('No quiz results found for user', currentUserId);
                }
            } catch (error) {
                console.error('Failed to load user progress:', error);
                document.getElementById('userTotalTokens').textContent = '0';
                document.getElementById('userCompletedTopics').textContent = '0/10';
            }
        }

        // Function to refresh user progress
        function refreshUserProgress() {
            loadUserProgress();
        }

        // Function to randomize all passcodes
        async function randomizeAllPasscodes() {
            if (!confirm('Are you sure you want to randomize ALL user passcodes? This will change every user\'s passcode except M514. Users will need to be notified of their new passcodes.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/randomize-passcodes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Passcodes randomized successfully! ${data.randomizedCount} passcodes were changed.`);
                    // Refresh the user management table to show new passcodes
                    loadUserManagement();
                } else {
                    alert('Failed to randomize passcodes: ' + data.error);
                }
            } catch (error) {
                console.error('Error randomizing passcodes:', error);
                alert('Error randomizing passcodes. Please try again.');
            }
        }

        // Function to export user credentials as CSV
        async function exportUserCredentials() {
            try {
                // Use the server endpoint to generate and download CSV
                const response = await fetch('/api/admin/export-csv', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert('Failed to export CSV: ' + (errorData.error || 'Unknown error'));
                    return;
                }

                // Create blob and download
                const csvContent = await response.text();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `user_credentials_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                alert('User credentials CSV file downloaded successfully!');

            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please try again.');
            }
        }

        // Function to render team progress
        function renderTeamProgress(teamProgress) {
            const container = document.getElementById('teamProgressTable');

            if (!container) return;

            if (teamProgress.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No teams registered yet.</td></tr>';
                return;
            }

            let html = '';
            teamProgress.forEach(team => {
                const lastQuizDateTime = team.lastQuizDate ?
                    new Date(team.lastQuizDate).toLocaleString() :
                    'Never';

                html += `
                    <tr class="team-progress-row">
                        <td><strong>${team.name}</strong></td>
                        <td>${team.completedCount}/${team.totalTopics}</td>
                        <td>${team.totalScore}</td>
                        <td><span class="badge bg-warning">${team.totalTokens || 0} tokens</span></td>
                        <td>${team.averageScore}</td>
                        <td>${lastQuizDateTime}</td>
                    </tr>
                `;
            });

            container.innerHTML = html;
        }

        // Quiz Editor Functions
        let currentQuizData = null;
        let selectedTopic = null;

        function showEditQuizModal() {
            const modal = new bootstrap.Modal(document.getElementById('editQuizModal'));
            loadQuizTopics();
            modal.show();
        }

        async function loadQuizTopics() {
            try {
                const response = await fetch('/api/quiz-topics-admin', { credentials: 'include' });
                const data = await response.json();

                if (data.topics) {
                    renderQuizTopics(data.topics);
                }
            } catch (error) {
                console.error('Failed to load quiz topics:', error);
            }
        }

        function renderQuizTopics(topics) {
            const container = document.getElementById('quizTopicsList');
            container.innerHTML = '';

            topics.forEach(topic => {
                const topicItem = document.createElement('button');
                topicItem.className = 'list-group-item list-group-item-action';
                topicItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${topic.name}</h6>
                        <small class="text-muted">${topic.difficulty}</small>
                    </div>
                    <p class="mb-1 small">${topic.description}</p>
                    <small>${topic.questions.length} questions</small>
                `;
                topicItem.addEventListener('click', () => selectTopic(topic));
                container.appendChild(topicItem);
            });
        }

        function selectTopic(topic) {
            selectedTopic = topic;
            currentQuizData = { ...topic };
            renderQuizEditor(topic);

            // Update active state
            document.querySelectorAll('#quizTopicsList .list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.list-group-item').classList.add('active');
        }

        function renderQuizEditor(topic) {
            const editor = document.getElementById('quizEditor');
            let html = `
                <h5>${topic.name} - Questions Editor</h5>
                <p class="text-muted">${topic.description}</p>
                <div class="questions-editor">
            `;

            topic.questions.forEach((question, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Question ${index + 1}</h6>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${index})">
                                <i class="fas fa-trash"></i>
                                </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Question Text</label>
                                <textarea class="form-control" id="question_${index}" rows="2">${question.question}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Question Type</label>
                                <select class="form-select" id="type_${index}" onchange="toggleQuestionType(${index})">
                                    <option value="multiple-choice" ${question.type === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option>
                                    <option value="number" ${question.type === 'number' ? 'selected' : ''}>Number Input</option>
                                </select>
                            </div>
                            <div id="options_${index}">
                                ${question.type === 'multiple-choice' ? renderMultipleChoiceOptions(question, index) : renderNumberInput(question, index)}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <button class="btn btn-success" onclick="addNewQuestion()">
                    <i class="fas fa-plus me-2"></i>Add New Question
                </button>
            `;

            editor.innerHTML = html;
        }

        function renderMultipleChoiceOptions(question, index) {
            let html = '<div class="mb-3"><label class="form-label">Options</label>';

            question.options.forEach((option, optIndex) => {
                html += `
                    <div class="input-group mb-2">
                        <span class="input-group-text">${String.fromCharCode(65 + optIndex)}</span>
                        <input type="text" class="form-control" id="option_${index}_${optIndex}" value="${option}">
                        <button class="btn btn-outline-danger" onclick="removeOption(${index}, ${optIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });

            html += `
                <button class="btn btn-sm btn-outline-primary" onclick="addOption(${index})">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            `;

            html += '<div class="mb-3"><label class="form-label">Correct Answer</label>';
            html += `<select class="form-select" id="correct_${index}">`;
            question.options.forEach((option, optIndex) => {
                html += `<option value="${optIndex}" ${optIndex === question.correct ? 'selected' : ''}>${String.fromCharCode(65 + optIndex)}. ${option}</option>`;
            });
            html += '</select></div>';

            return html + '</div>';
        }

        function renderNumberInput(question, index) {
            return `
                <div class="mb-3">
                    <label class="form-label">Correct Answer</label>
                    <input type="number" class="form-control" id="answer_${index}" value="${question.answer}">
                </div>
            `;
        }

        function toggleQuestionType(index) {
            const type = document.getElementById(`type_${index}`).value;
            const optionsDiv = document.getElementById(`options_${index}`);

            if (type === 'multiple-choice') {
                optionsDiv.innerHTML = renderMultipleChoiceOptions({ options: ['Option A', 'Option B', 'Option C', 'Option D'], correct: 0 }, index);
            } else {
                optionsDiv.innerHTML = renderNumberInput({ answer: 0 }, index);
            }
        }

        function addOption(questionIndex) {
            const optionsDiv = document.getElementById(`options_${questionIndex}`);
            const optionCount = optionsDiv.querySelectorAll('.input-group').length;
            const newOptionHtml = `
                <div class="input-group mb-2">
                    <span class="input-group-text">${String.fromCharCode(65 + optionCount)}</span>
                    <input type="text" class="form-control" id="option_${questionIndex}_${optionCount}" value="New Option">
                    <button class="btn btn-outline-danger" onclick="removeOption(${questionIndex}, ${optionCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            const addButton = optionsDiv.querySelector('button');
            addButton.insertAdjacentHTML('beforebegin', newOptionHtml);
        }

        function removeOption(questionIndex, optionIndex) {
            const optionElement = document.getElementById(`option_${questionIndex}_${optionIndex}`).closest('.input-group');
            if (optionElement) {
                optionElement.remove();
            }
        }

        function addNewQuestion() {
            if (!selectedTopic) return;

            const newQuestion = {
                type: 'multiple-choice',
                question: 'New question text',
                options: ['Option A', 'Option B', 'Option C', 'Option D'],
                correct: 0
            };

            currentQuizData.questions.push(newQuestion);
            renderQuizEditor(currentQuizData);
        }

        function removeQuestion(index) {
            if (confirm('Are you sure you want to remove this question?')) {
                currentQuizData.questions.splice(index, 1);
                renderQuizEditor(currentQuizData);
            }
        }

        async function saveQuizChanges() {
            if (!selectedTopic || !currentQuizData) return;

            try {
                const response = await fetch('/api/update-quiz-topic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        topicId: selectedTopic.id,
                        topicData: currentQuizData
                    })
                });

                if (response.ok) {
                    alert('Quiz questions updated successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editQuizModal'));
                    modal.hide();
                } else {
                    alert('Failed to update quiz questions');
                }
            } catch (error) {
                console.error('Error saving quiz changes:', error);
                alert('Error saving quiz changes');
            }
        }

        // Admin reset function
        async function resetAllData() {
            if (!confirm('Are you sure you want to reset ALL data? This will delete all teams, quiz results, and tokens. This action cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch('/api/admin-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        adminPasscode: 'M514'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('All data has been reset successfully!');
                    // Refresh the admin data
                    loadTeamProgress();
                } else {
                    alert('Failed to reset data: ' + data.error);
                }
            } catch (error) {
                console.error('Error resetting data:', error);
                alert('Error resetting data. Please try again.');
            }
        }

        // Admin Access Form Handler
        document.addEventListener('DOMContentLoaded', function () {
            const adminAccessForm = document.getElementById('adminAccessForm');
            if (adminAccessForm) {
                adminAccessForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const passcode = document.getElementById('adminPasscode').value;

                    if (passcode === 'M514') {
                        // Show admin section
                        document.getElementById('adminSection').style.display = 'block';

                        // Load admin data
                        loadQuizQuestions();
                        loadTeamProgress();
                        loadUserManagement();

                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('adminAccessModal'));
                        modal.hide();

                        // Show success message
                        alert('Admin access granted!');
                    } else {
                        alert('Invalid admin passcode!');
                    }
                });
            }
        });

        // User Management Functions
        async function loadUserManagement() {
            try {
                console.log('Loading user management data...');

                // Get all passcodes
                const passcodeResponse = await fetch('/api/admin/passcodes', { credentials: 'include' });
                const passcodeData = await passcodeResponse.json();

                if (!passcodeData.success) {
                    console.error('Failed to load passcodes:', passcodeData.error);
                    return;
                }

                // Get user login history
                const loginResponse = await fetch('/api/admin/user-logins', { credentials: 'include' });
                const loginData = await loginResponse.json();

                if (!loginData.success) {
                    console.error('Failed to load user logins:', loginData.error);
                    return;
                }

                console.log('Passcode data:', passcodeData.passcodes);
                console.log('Login data:', loginData.users);

                // Combine the data
                const combinedUsers = passcodeData.passcodes.map(passcodeInfo => {
                    const loginInfo = loginData.users.find(login => login.userId === passcodeInfo.userId);
                    return {
                        userId: passcodeInfo.userId,
                        passcode: passcodeInfo.passcode,
                        lastLogin: loginInfo ? loginInfo.loginTime : 'Never',
                        userType: parseInt(passcodeInfo.userId) <= 16 ? 'Marble Run' : 'Individual'
                    };
                }).sort((a, b) => parseInt(a.userId) - parseInt(b.userId));

                renderUserManagementTable(combinedUsers);

            } catch (error) {
                console.error('Failed to load user management data:', error);
            }
        }

        function renderUserManagementTable(users) {
            const container = document.getElementById('userManagementTable');
            const countElement = document.getElementById('totalUsersCount');

            if (!container || !countElement) {
                console.error('User management container or count element not found');
                return;
            }

            countElement.textContent = users.length;

            if (users.length === 0) {
                container.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users found.</td></tr>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const lastLoginFormatted = user.lastLogin === 'Never' ?
                    'Never' :
                    new Date(user.lastLogin).toLocaleString();

                const isAdmin = user.userId === '201';
                const adminBadge = isAdmin ? '<span class="badge bg-danger ms-2">ADMIN</span>' : '';

                html += `
                    <tr>
                        <td><strong>${user.userId}</strong>${adminBadge}</td>
                        <td>
                            <code class="bg-light px-2 py-1 rounded">${user.passcode}</code>
                        </td>
                        <td>${lastLoginFormatted}</td>
                        <td>
                            <span class="badge ${user.userType === 'Marble Run' ? 'bg-primary' : 'bg-secondary'}">
                                ${user.userType}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editUserPasskey('${user.userId}', '${user.passcode}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;
        }

        function showPasscodeModal() {
            const modal = new bootstrap.Modal(document.getElementById('addPasscodeModal'));
            modal.show();
        }

        function editUserPasskey(userId, currentPasscode) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editCurrentPasscode').value = currentPasscode;
            document.getElementById('editNewPasscode').value = '';

            const modal = new bootstrap.Modal(document.getElementById('editPasskeyModal'));
            modal.show();
        }

        async function updateUserPasskey() {
            const userId = document.getElementById('editUserId').value;
            const newPasscode = document.getElementById('editNewPasscode').value.toUpperCase();

            if (!newPasscode) {
                alert('Please enter a new passcode');
                return;
            }

            if (!/^[A-Z0-9]{4}$/.test(newPasscode)) {
                alert('Passcode must be exactly 4 alphanumeric characters');
                return;
            }

            try {
                const response = await fetch('/api/admin/update-passkey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: userId,
                        newPasscode: newPasscode
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Passkey updated successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editPasskeyModal'));
                    modal.hide();
                    loadUserManagement(); // Refresh the table
                } else {
                    alert('Failed to update passkey: ' + data.error);
                }
            } catch (error) {
                console.error('Error updating passkey:', error);
                alert('Error updating passkey');
            }
        }

        async function addNewPasscode() {
            const userId = document.getElementById('newUserId').value;
            const passcode = document.getElementById('newPasscode').value.toUpperCase();

            if (!userId || !passcode) {
                alert('Please enter both user ID and passcode');
                return;
            }

            if (!/^[A-Z0-9]{4}$/.test(passcode)) {
                alert('Passcode must be exactly 4 alphanumeric characters');
                return;
            }

            try {
                const response = await fetch('/api/admin/update-passkey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: userId,
                        newPasscode: passcode
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('New passcode added successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addPasscodeModal'));
                    modal.hide();
                    document.getElementById('addPasscodeForm').reset();
                    loadUserManagement(); // Refresh the table
                } else {
                    alert('Failed to add passcode: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding passcode:', error);
                alert('Error adding passcode');
            }
        }
    </script>

</body>

</html>